generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// AuctionHouse model - represents a multi-tenant auction house organization
model AuctionHouse {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique // URL-friendly identifier (e.g., "heritage-judaica")
  domain      String?  @unique // Custom domain (optional)
  description String?
  logoUrl     String?  @map("logo_url")
  settings    String?  // JSON string for custom settings
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  users    User[]    // Users belonging to this auction house (sellers, auctioneers)
  auctions Auction[] // Auctions hosted by this auction house

  @@index([slug])
  @@index([isActive])
  @@map("auction_houses")
}

// User model - represents users in the system
// Note: Authentication is handled externally, this stores local profile data
model User {
  id            String       @id @default(cuid())
  email         String       @unique
  name          String?
  firstName     String?      @map("first_name")
  lastName      String?      @map("last_name")
  role          UserRole     @default(BUYER)
  auctionHouseId String?     @map("auction_house_id") // For sellers/auctioneers
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  // Relations
  auctionHouse AuctionHouse? @relation(fields: [auctionHouseId], references: [id], onDelete: SetNull)
  auctions     Auction[]     // Auctions created by this user (if seller)
  bids         Bid[]

  @@index([auctionHouseId])
  @@index([role])
  @@map("users")
}

enum UserRole {
  BUYER
  SELLER
  AUCTIONEER
}

// Auction model - represents an auction event
model Auction {
  id            String        @id @default(cuid())
  title         String
  description   String?
  startDate     DateTime      @map("start_date")
  endDate       DateTime      @map("end_date")
  status        AuctionStatus  @default(UPCOMING)
  imageUrl      String?       @map("image_url")
  auctionHouseId String       @map("auction_house_id") // Multi-tenant: which auction house hosts this
  sellerId      String        @map("seller_id")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  auctionHouse AuctionHouse @relation(fields: [auctionHouseId], references: [id], onDelete: Cascade)
  seller       User        @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  lots         Lot[]

  @@index([auctionHouseId])
  @@index([sellerId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@map("auctions")
}

enum AuctionStatus {
  UPCOMING
  LIVE
  ENDED
  CANCELLED
}

// Lot model - represents an individual lot/item in an auction
model Lot {
  id                String     @id @default(cuid())
  auctionId         String     @map("auction_id")
  lotNumber         Int        @map("lot_number")
  title             String
  hebrewTitle       String?    @map("hebrew_title")
  description       String?
  hebrewDescription String?   @map("hebrew_description")
  category          String?
  startingBid       Float      @map("starting_bid")
  currentBid        Float      @default(0) @map("current_bid")
  bidIncrement      Float      @map("bid_increment")
  imageUrl          String?    @map("image_url")
  imageUrls         String?    @map("image_urls") // JSON array of multiple images
  status            LotStatus  @default(ACTIVE)
  endTime           DateTime?  @map("end_time")
  highestBidderId   String?    @map("highest_bidder_id")
  highestBidderName String?    @map("highest_bidder_name")
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")

  // Relations
  auction Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  bids    Bid[]

  @@unique([auctionId, lotNumber])
  @@index([auctionId])
  @@index([status])
  @@index([endTime])
  @@map("lots")
}

enum LotStatus {
  ACTIVE
  SOLD
  UNSOLD
  WITHDRAWN
}

// Bid model - represents a bid placed on a lot
model Bid {
  id        String   @id @default(cuid())
  lotId     String   @map("lot_id")
  userId    String   @map("user_id")
  userName  String?  @map("user_name")
  amount    Float
  timestamp DateTime @default(now())

  // Relations
  lot  Lot    @relation(fields: [lotId], references: [id], onDelete: Cascade)
  user User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([lotId])
  @@index([userId])
  @@index([timestamp])
  @@map("bids")
}
